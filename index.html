<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Rohstoffkarte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
    }

    .legend-container {
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 1000;
    }

    .legend-toggle {
      background: white;
      border: 1px solid #ccc;
      border-radius: 5px;
      cursor: pointer;
      padding: 5px 8px;
      font-size: 16px;
    }

    .legend-box {
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 10px;
      margin-top: 8px;
      display: none;
    }

    .legend-icon {
      width: 30px;
      height: 30px;
      margin: 5px;
      cursor: pointer;
    }

    .selected {
      outline: 2px solid blue;
    }

    .importance-button {
      padding: 5px 10px;
      margin: 5px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      color: white;
    }

    .importance-low {
      background-color: green;
    }

    .importance-medium {
      background-color: orange;
    }

    .importance-high {
      background-color: red;
    }

    .control-buttons {
      margin-top: 10px;
    }

    .control-buttons button {
      margin: 3px;
      padding: 5px 10px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="legend-container">
    <button class="legend-toggle" onclick="toggleLegends()">ðŸ¡¹</button>

    <div id="legend" class="legend-box">
      <strong>Rohstoffe:</strong><br>
      <img src="https://i.postimg.cc/MKtSBSKG/TOOLS-069-removebg-preview.png" class="legend-icon" onclick="selectIcon(this, 'Eisen')">
      <img src="https://i.postimg.cc/NG6YgX3m/Shid-removebg-preview.png" class="legend-icon" onclick="selectIcon(this, 'Kupfer')">
      <img src="https://i.postimg.cc/7LjDLnPM/Science-flask-symbol-removebg-preview.png" class="legend-icon" onclick="selectIcon(this, 'Lithium')">
      <img src="https://i.postimg.cc/Twmx55p8/Religious-Salt-free-icons-designed-by-Freepik-removebg-preview.png" class="legend-icon" onclick="selectIcon(this, 'Salz')">
      <img src="https://i.postimg.cc/FHRQgB7V/images-removebg-preview.png" class="legend-icon" onclick="selectIcon(this, 'Erdgas')">
      <img src="https://i.postimg.cc/T37fzXZs/H2o-Clipart-Transparent-Background-Vector-H2o-Icon-H20-Water-Drop-PNG-Image-For-Free-Download-re.png" class="legend-icon" onclick="selectIcon(this, 'Wasser')">
      <img src="https://i.postimg.cc/kXynySwq/Download-16-removebg-preview.png" class="legend-icon" onclick="selectIcon(this, 'Holz')">
      <img src="https://i.postimg.cc/3J3hWRh6/Download-15-removebg-preview.png" class="legend-icon" onclick="selectIcon(this, 'Diamant')">
      <img src="https://i.postimg.cc/pL6M0Jjb/Download-14-removebg-preview.png" class="legend-icon" onclick="selectIcon(this, 'Kohle')">
      <img src="https://i.postimg.cc/g0xmdTp2/Alchemy-Symbols-Visual-Library-of-Alchemy-Symbols-removebg-preview.png" class="legend-icon" onclick="selectIcon(this, 'Uran')">
    </div>

    <div id="importance" class="legend-box">
      <strong>Wichtigkeit:</strong><br>
      <button class="importance-button importance-low" onclick="setImportance('low')">Niedrig</button>
      <button class="importance-button importance-medium" onclick="setImportance('medium')">Mittel</button>
      <button class="importance-button importance-high" onclick="setImportance('high')">Hoch</button>
      <div class="control-buttons">
        <button onclick="clearAllMarkers()">Alle lÃ¶schen</button>
        <button onclick="exportMarkers()">Exportieren</button>
        <input type="file" onchange="importMarkers(event)">
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([20, 0], 2);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap-Mitwirkende'
    }).addTo(map);

    let selectedIconUrl = null;
    let selectedIconEl = null;
    let selectedImportance = 'low';
    const markers = [];

    function selectIcon(el, name) {
      if (selectedIconEl === el) {
        selectedIconUrl = null;
        selectedIconEl.classList.remove("selected");
        selectedIconEl = null;
      } else {
        if (selectedIconEl) selectedIconEl.classList.remove("selected");
        selectedIconUrl = el.src;
        el.classList.add("selected");
        selectedIconEl = el;
      }
    }

    function setImportance(level) {
      selectedImportance = level;
    }

    function toggleLegends() {
      const legend = document.getElementById("legend");
      const importance = document.getElementById("importance");
      const isVisible = legend.style.display === "block";
      legend.style.display = isVisible ? "none" : "block";
      importance.style.display = isVisible ? "none" : "block";
    }

    function saveMarkers() {
      const data = markers.map(m => ({
        lat: m.getLatLng().lat,
        lng: m.getLatLng().lng,
        iconUrl: m.options.icon.options.iconUrl,
        importance: m.options.icon.options.className.replace("importance-", ""),
        tooltip: m.getTooltip()?.getContent() || ""
      }));
      localStorage.setItem("savedMarkers", JSON.stringify(data));
    }

    function loadMarkers() {
      const data = JSON.parse(localStorage.getItem("savedMarkers"));
      if (!data) return;
      data.forEach(item => createMarker(item.lat, item.lng, item.iconUrl, item.importance, item.tooltip));
    }

    function createMarker(lat, lng, iconUrl, importance, tooltipText = "") {
      const icon = L.icon({
        iconUrl: iconUrl,
        iconSize: [32, 32],
        className: `importance-${importance}`
      });

      const marker = L.marker([lat, lng], { icon }).addTo(map);
      if (tooltipText) marker.bindTooltip(tooltipText, { permanent: false });

      marker.on('contextmenu', function () {
        map.removeLayer(marker);
        markers.splice(markers.indexOf(marker), 1);
        saveMarkers();
      });

      markers.push(marker);
      saveMarkers();

      map.on('zoomend', function () {
        const currentZoom = map.getZoom();
        if (currentZoom < 4) map.removeLayer(marker);
        else map.addLayer(marker);
      });
    }

    map.on('click', function (e) {
      if (selectedIconUrl) {
        const tooltipText = prompt("Beschreibung fÃ¼r diesen Punkt?");
        createMarker(e.latlng.lat, e.latlng.lng, selectedIconUrl, selectedImportance, tooltipText);
      }
    });

    function clearAllMarkers() {
      markers.forEach(marker => map.removeLayer(marker));
      markers.length = 0;
      localStorage.removeItem("savedMarkers");
    }

    function exportMarkers() {
      const dataStr = JSON.stringify(markers.map(m => ({
        lat: m.getLatLng().lat,
        lng: m.getLatLng().lng,
        iconUrl: m.options.icon.options.iconUrl,
        importance: m.options.icon.options.className.replace("importance-", ""),
        tooltip: m.getTooltip()?.getContent() || ""
      })), null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "marker_export.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    function importMarkers(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        const data = JSON.parse(e.target.result);
        clearAllMarkers();
        data.forEach(item => createMarker(item.lat, item.lng, item.iconUrl, item.importance, item.tooltip));
      };
      reader.readAsText(file);
    }

    loadMarkers();
  </script>
</body>
</html>
